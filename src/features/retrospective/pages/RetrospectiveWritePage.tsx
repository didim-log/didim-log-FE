/**
 * 회고 작성 페이지
 */

import { useState, useEffect } from 'react';
import type { FC } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { useCreateRetrospective, useStaticTemplate } from '../../../hooks/api/useRetrospective';
import { useProblemDetail } from '../../../hooks/api/useProblem';
import { RetrospectiveEditor } from '../components/RetrospectiveEditor';
import { Spinner } from '../../../components/ui/Spinner';
import { Layout } from '../../../components/layout/Layout';
import { Button } from '../../../components/ui/Button';
import { TierBadge } from '../../dashboard/components/TierBadge';
import { formatTierFromDifficulty, getTierColor } from '../../../utils/tier';
import { toast } from 'sonner';
import { Copy } from 'lucide-react';
import type { RetrospectiveRequest } from '../../../types/api/retrospective.types';

export const RetrospectiveWritePage: FC = () => {
    const location = useLocation();
    const navigate = useNavigate();
    const createMutation = useCreateRetrospective();
    const staticTemplateMutation = useStaticTemplate();

    const [problemId, setProblemId] = useState<string>('');
    const [template, setTemplate] = useState<string>('');
    const [isSuccess, setIsSuccess] = useState<boolean>(false);
    const [content, setContent] = useState<string>('');
    const [isLoadingTemplate, setIsLoadingTemplate] = useState(false);
    const [hasLoadedTemplate, setHasLoadedTemplate] = useState(false);

    // 문제 상세 정보 조회
    const { data: problem, isLoading: isProblemLoading } = useProblemDetail(problemId);

    const loadTemplate = async (pid: string, code: string, success: boolean) => {
        if (hasLoadedTemplate) {
            return; // 이미 로드했으면 중복 호출 방지
        }

        setIsLoadingTemplate(true);
        try {
            const result = await staticTemplateMutation.mutateAsync({
                code: code,
                problemId: pid,
                isSuccess: success,
                errorMessage: success ? null : '제출 실패',
            });
            setTemplate(result.template);
            setContent(result.template);
            setHasLoadedTemplate(true);
        } catch (error) {
            console.error('Template load failed:', error);
            // Fallback: 최소한의 기본 템플릿 제공
            const fallbackTemplate = `# ${pid}번 문제 회고\n\n## 접근 방법\n\n<!-- 여기에 접근 방법을 작성하세요 -->\n\n## 복잡도 분석\n\n<!-- 여기에 시간/공간 복잡도를 작성하세요 -->\n\n## 제출한 코드\n\n\`\`\`\n${code}\n\`\`\`\n`;
            setContent(fallbackTemplate);
            setHasLoadedTemplate(true);
        } finally {
            setIsLoadingTemplate(false);
        }
    };

    useEffect(() => {
        // location.state에서 전달된 데이터 확인
        const state = location.state as {
            problemId?: string;
            template?: string;
            isSuccess?: boolean;
            code?: string;
        } | null;

        if (state) {
            const { problemId: pid, template: temp, isSuccess: success, code: codeValue } = state;
            
            // problemId 설정 (최우선)
            if (pid) {
                setProblemId(pid);
            }
            
            setIsSuccess(success ?? false);

            // 템플릿 로드 우선순위:
            // 1. 템플릿이 이미 있으면 즉시 사용
            if (temp) {
                setTemplate(temp);
                setContent(temp);
                setHasLoadedTemplate(true);
            }
            // 2. 템플릿이 없고 code와 isSuccess가 있으면 즉시 API 호출
            else if (pid && codeValue !== undefined && codeValue !== null && codeValue !== '' && success !== undefined) {
                // 즉시 템플릿 로드 (비동기)
                loadTemplate(pid, codeValue, success).catch((error) => {
                    console.error('Template load error:', error);
                });
            }
            // 3. 문제 ID만 있는 경우 기본 템플릿 제공
            else if (pid) {
                const basicTemplate = `# ${pid}번 문제 회고\n\n## 접근 방법\n\n<!-- 여기에 접근 방법을 작성하세요 -->\n\n## 복잡도 분석\n\n<!-- 여기에 시간/공간 복잡도를 작성하세요 -->\n\n`;
                setContent(basicTemplate);
                setHasLoadedTemplate(true);
            }
        }
    }, [location.state]);

    const handleCopyMarkdown = async () => {
        if (!content.trim() || !problemId) {
            toast.error('복사할 내용이 없습니다.');
            return;
        }

        // AI Generated 문구 제거 및 출처 푸터 추가
        let markdownContent = content.trim();
        
        // AI Generated 관련 문구 제거 (대소문자 무관)
        markdownContent = markdownContent
            .replace(/AI Generated/gi, '')
            .replace(/AI generated/gi, '')
            .replace(/Generated by AI/gi, '')
            .replace(/generated by ai/gi, '')
            .replace(/AI가 생성/gi, '')
            .replace(/자동 생성/gi, '')
            .trim();

        // 출처 푸터 추가
        const footer = '\n\n> _Generated by DidimLog_';
        markdownContent = markdownContent + footer;

        try {
            await navigator.clipboard.writeText(markdownContent);
            toast.success('마크다운이 클립보드에 복사되었습니다!');
        } catch (error) {
            console.error('클립보드 복사 실패:', error);
            toast.error('클립보드 복사에 실패했습니다. 브라우저 권한을 확인해주세요.');
        }
    };

    const handleSubmit = async (data: RetrospectiveRequest) => {
        if (!problemId) {
            toast.error('문제 ID가 없습니다.');
            return;
        }

        try {
            await createMutation.mutateAsync({ problemId, data });
            toast.success('회고가 저장되었습니다.');
            navigate('/retrospectives');
        } catch (error: any) {
            console.error('Create failed:', error);
            const errorMessage = error?.response?.data?.message || error?.message || '회고 저장에 실패했습니다.';
            toast.error(errorMessage);
        }
    };

    const handleContentChange = (newContent: string) => {
        setContent(newContent);
    };

    return (
        <Layout>
            <div className="min-h-screen bg-gray-50 dark:bg-gray-900 py-8 px-4">
                <div className="max-w-4xl mx-auto space-y-8">
                    {/* 문제 정보 헤더 카드 */}
                    {problemId && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 border border-gray-200 dark:border-gray-700">
                            {isProblemLoading ? (
                                <div className="flex items-center justify-center py-8">
                                    <Spinner />
                                    <span className="ml-3 text-gray-600 dark:text-gray-400">문제 정보를 불러오는 중...</span>
                                </div>
                            ) : problem ? (
                                <div className="flex items-start gap-6">
                                    {/* 티어 이미지 */}
                                    <div className="flex-shrink-0">
                                        <TierBadge tierLevel={problem.difficultyLevel} size="lg" />
                                    </div>
                                    
                                    {/* 문제 정보 */}
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-start justify-between mb-4">
                                            <div className="flex-1">
                                                <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-3">
                                                    {problem.id}. {problem.title}
                                                </h1>
                                                <div className="flex items-center gap-3 flex-wrap mb-3">
                                                    <span className="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm font-medium">
                                                        {problem.category}
                                                    </span>
                                                    <span className={`px-3 py-1 rounded-lg text-sm font-medium ${getTierColor(problem.difficulty)}`}>
                                                        {formatTierFromDifficulty(problem.difficulty, problem.difficultyLevel)}
                                                    </span>
                                                </div>
                                                {/* 알고리즘 태그 표시 */}
                                                {problem.tags && problem.tags.length > 0 && (
                                                    <div className="flex items-center gap-2 flex-wrap">
                                                        <span className="text-xs text-gray-500 dark:text-gray-400">태그:</span>
                                                        {problem.tags.map((tag, index) => (
                                                            <span
                                                                key={index}
                                                                className="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs"
                                                            >
                                                                {tag}
                                                            </span>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center py-4">
                                    <p className="text-gray-600 dark:text-gray-400">문제 #{problemId} 정보를 불러올 수 없습니다.</p>
                                </div>
                            )}
                        </div>
                    )}

                    {/* 헤더 (액션 버튼) */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between">
                            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">회고 작성</h2>
                            <div className="flex items-center gap-3">
                                <Button 
                                    onClick={handleCopyMarkdown} 
                                    variant="outline" 
                                    className="flex items-center gap-2"
                                >
                                    <Copy className="w-4 h-4" />
                                    Markdown 복사
                                </Button>
                            </div>
                        </div>
                    </div>

                    {isLoadingTemplate && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 border border-gray-200 dark:border-gray-700">
                            <div className="flex items-center justify-center py-12">
                                <Spinner />
                                <span className="ml-3 text-gray-600 dark:text-gray-400">템플릿을 불러오는 중...</span>
                            </div>
                        </div>
                    )}

                    {/* 회고 에디터 */}
                    {!isLoadingTemplate && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 border border-gray-200 dark:border-gray-700">
                            <RetrospectiveEditor
                                initialContent={content || template}
                                initialResultType={isSuccess ? 'SUCCESS' : 'FAIL'}
                                onSubmit={handleSubmit}
                                isLoading={createMutation.isPending}
                                onContentChange={handleContentChange}
                            />
                        </div>
                    )}
                </div>
            </div>
        </Layout>
    );
};

