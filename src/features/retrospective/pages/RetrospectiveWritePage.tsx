/**
 * íšŒê³  ì‘ì„± í˜ì´ì§€
 */

import { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import type { FC } from 'react';
import { useLocation, useNavigate, useSearchParams } from 'react-router-dom';
import { useCreateRetrospective, useRetrospective, useUpdateRetrospective } from '../../../hooks/api/useRetrospective';
import { useTemplateSummaries, useRenderTemplate, useTemplates } from '../../../hooks/api/useTemplate';
import { useProblemDetail } from '../../../hooks/api/useProblem';
import { RetrospectiveEditor } from '../components/RetrospectiveEditor';
import { Spinner } from '../../../components/ui/Spinner';
import { Layout } from '../../../components/layout/Layout';
import { Button } from '../../../components/ui/Button';
import { formatTierFromDifficulty, getTierColor } from '../../../utils/tier';
import { LanguageBadge } from '../../../components/common/LanguageBadge';
import { toast } from 'sonner';
import { getErrorMessage, isApiError } from '../../../types/api/common.types';
import { useOnboardingStore } from '../../../stores/onboarding.store';
import { Copy, ChevronLeft } from 'lucide-react';
import type { ProblemResult, RetrospectiveRequest } from '../../../types/api/retrospective.types';
import { AiReviewCard } from '../../../components/retrospective/AiReviewCard';
import type { TemplateSummary } from '../../../types/api/template.types';
import { buildRepresentativeCategoriesFromSource } from '../../../utils/problemCategory';
import { getCategoryLabel } from '../../../utils/constants';

/**
 * ì œëª© ì´ˆê¸°ê°’ í¬ë§· ìƒìˆ˜
 * ì„±ê³µ: í•´ê²° íšŒê³ , ì‹¤íŒ¨: ë¯¸í•´ê²° íšŒê³ 
 */
const DEFAULT_TITLE_FORMAT = '# ğŸ† [ë°±ì¤€/BOJ] {{problemId}}ë²ˆ {{problemTitle}} ({{language}}) {{result}} íšŒê³ ';

/**
 * ì œëª© í¬ë§·ì˜ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
 */
const formatTitle = (format: string, params: {
    problemId: string;
    problemTitle: string;
    language: string;
    result: string;
}): string => {
    return format
        .replace(/\{\{problemId\}\}/g, params.problemId)
        .replace(/\{\{problemTitle\}\}/g, params.problemTitle)
        .replace(/\{\{language\}\}/g, params.language)
        .replace(/\{\{result\}\}/g, params.result);
};

type TemplateFallbackInfo = {
    reason: string | null;
};

const getTemplateFallbackMessage = (reason: string | null): string => {
    if (reason === 'TEMPLATE_RENDER_TIMEOUT') {
        return 'í…œí”Œë¦¿ ë Œë”ë§ ì‹œê°„ì´ ì´ˆê³¼ë˜ì–´ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
    return 'í…œí”Œë¦¿ ë Œë”ë§ ì¤‘ ì¼ë¶€ ë¬¸ì œê°€ ë°œìƒí•´ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.';
};

/**
 * ì¤‘ë³µëœ "ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ ì œê±° ë° ì •ë¦¬
 */
const removeDuplicateCodeSections = (content: string): string => {
    // ëª¨ë“  "## ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ ì°¾ê¸° (ë” ì •í™•í•œ íŒ¨í„´)
    // ì„¹ì…˜ í—¤ë”ë¶€í„° ë‹¤ìŒ ì„¹ì…˜ í—¤ë”ë‚˜ êµ¬ë¶„ì„ , ë¬¸ì„œ ëê¹Œì§€ ë§¤ì¹­
    const codeSectionPattern = /(##\s*ì œì¶œí•œ\s*ì½”ë“œ(?:\s*\n|[\s\S]*?)(?:```[\s\S]*?```|(?=\n##|\n---|$)))/gi;
    const matches: RegExpMatchArray[] = [];
    let match: RegExpMatchArray | null;
    
    // ëª¨ë“  ë§¤ì¹­ ê²°ê³¼ ìˆ˜ì§‘
    while ((match = codeSectionPattern.exec(content)) !== null) {
        matches.push(match);
    }
    
    if (matches.length <= 1) {
        return content; // ì¤‘ë³µì´ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    }
    
    // ë§ˆì§€ë§‰ "## ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ë§Œ ìœ ì§€
    // ëª¨ë“  ì„¹ì…˜ì„ ì—­ìˆœìœ¼ë¡œ ì œê±° (ë’¤ì—ì„œë¶€í„° ì œê±°í•˜ì—¬ ì¸ë±ìŠ¤ ë¬¸ì œ ë°©ì§€)
    let cleaned = content;
    for (let i = matches.length - 2; i >= 0; i--) {
        // ë§ˆì§€ë§‰ ì„¹ì…˜ì´ ì•„ë‹Œ ê²ƒë“¤ë§Œ ì œê±°
        const matchText = matches[i][0];
        cleaned = cleaned.replace(matchText, '');
    }
    
    // ì¤‘ë³µëœ ê³µë°± ì¤„ ì •ë¦¬
    cleaned = cleaned.replace(/\n{3,}/g, '\n\n').trim();
    
    return cleaned;
};

/**
 * í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
 */
const replacePlaceholders = (
    content: string,
    problemId: string,
    tier?: string | null
): string => {
    // ë¬¸ì œ ë§í¬ ìƒì„±
    const problemLink = `https://www.acmicpc.net/problem/${problemId}`;
    
    // í‹°ì–´ ì •ë³´ (ì—†ìœ¼ë©´ "í‹°ì–´ ì •ë³´ ì—†ìŒ")
    const tierText = tier || 'í‹°ì–´ ì •ë³´ ì—†ìŒ';
    
    // í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜
    return content
        .replace(/\{\{link\}\}/g, problemLink)
        .replace(/\{\{tier\}\}/g, tierText);
};

/**
 * í…œí”Œë¦¿ì— ê¸°ë³¸ ì„¹ì…˜ ì¶”ê°€ (ì œì¶œí•œ ì½”ë“œ, ë¬¸ì œ ë§í¬, Generated by DidimLog)
 * ëª¨ë“  í…œí”Œë¦¿(ì‹œìŠ¤í…œ/ì»¤ìŠ¤í…€)ì— ì¼ê´€ë˜ê²Œ ì ìš©
 */
const ensureDefaultSections = (
    templateContent: string,
    problemId: string,
    tier?: string | null
): string => {
    // ì¤‘ë³µëœ "ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ ì œê±°
    let cleanedContent = removeDuplicateCodeSections(templateContent);
    
    // ê¸°ì¡´ ë©”íƒ€ ì •ë³´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    // ë§ˆì§€ë§‰ì— ìˆëŠ” --- ì´í›„ì˜ ë©”íƒ€ ì •ë³´ ì œê±°
    cleanedContent = cleanedContent.replace(/\n---\n.*\[ë¬¸ì œ ë§í¬\].*Generated by DidimLog.*$/s, '').trim();
    
    // "## ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ íŒ¨í„´ í™•ì¸
    const codeSectionPattern = /##\s*ì œì¶œí•œ\s*ì½”ë“œ[\s\S]*?```[\s\S]*?```/i;
    const hasCompleteCodeSection = codeSectionPattern.test(cleanedContent);
    
    // ê¸°ë³¸ ì„¹ì…˜ ë°°ì—´
    const defaultSections: string[] = [];
    
    // ì™„ì „í•œ "## ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€
    if (!hasCompleteCodeSection) {
        // ë¶ˆì™„ì „í•œ ì„¹ì…˜ ì œê±° (í—¤ë”ë§Œ ìˆê³  ì½”ë“œ ë¸”ë¡ì´ ì—†ëŠ” ê²½ìš°)
        cleanedContent = cleanedContent.replace(/##\s*ì œì¶œí•œ\s*ì½”ë“œ\s*\n?/gi, '').trim();
        
        defaultSections.push('## ì œì¶œí•œ ì½”ë“œ');
        defaultSections.push('```kotlin\nì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.\n```');
    }
    
    // êµ¬ë¶„ì„ ê³¼ ë©”íƒ€ ì •ë³´ëŠ” í•­ìƒ ë§ˆì§€ë§‰ì— ì¶”ê°€
    defaultSections.push('---');
    defaultSections.push(`[ë¬¸ì œ ë§í¬]({{link}}) | í‹°ì–´: {{tier}}`);
    defaultSections.push('Generated by DidimLog');
    
    // ë§ˆì§€ë§‰ì— ê¸°ë³¸ ì„¹ì…˜ ì¶”ê°€
    const contentWithDefaults = cleanedContent + '\n\n' + defaultSections.join('\n\n');
    
    // í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
    return replacePlaceholders(contentWithDefaults, problemId, tier);
};

/**
 * í…œí”Œë¦¿ì˜ ì½”ë“œ ë¸”ë¡ì— ì œì¶œí•œ ì½”ë“œë¥¼ ì‚½ì…
 * ì½”ë“œ ë¸”ë¡ íŒ¨í„´: ```language\n...\n```
 * "ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ì˜ ë¹ˆ ì½”ë“œ ë¸”ë¡ì—ë§Œ ì½”ë“œë¥¼ ì±„ì›€
 */
const insertCodeIntoTemplate = (templateContent: string, code: string, programmingLanguage: string): string => {
    if (!code || !code.trim()) {
        return templateContent;
    }

    const normalizedLang = programmingLanguage.toLowerCase();
    
    // "ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ì„ ì°¾ê¸°
    const ì œì¶œí•œì½”ë“œSectionPattern = /##\s*ì œì¶œí•œ\s*ì½”ë“œ[\s\S]*?```(\w+)?\n([\s\S]*?)```/i;
    const match = templateContent.match(ì œì¶œí•œì½”ë“œSectionPattern);
    
    if (match) {
        const lang = match[1];
        const existingContent = match[2];
        const trimmedContent = existingContent.trim();
        
        // í”Œë ˆì´ìŠ¤í™€ë”ê°€ ìˆê±°ë‚˜ ë¹ˆ ê²½ìš°ì—ë§Œ ì½”ë“œ ì‚½ì…
        if (!trimmedContent || 
            trimmedContent.includes('ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”') || 
            trimmedContent.includes('Write your code here') ||
            trimmedContent === '') {
            
            // ì–¸ì–´ íƒœê·¸ê°€ ì—†ê±°ë‚˜ 'text'ì¸ ê²½ìš° í”„ë¡œê·¸ë˜ë° ì–¸ì–´ ì‚¬ìš©
            const codeLanguage = (lang && lang !== 'text') ? lang : (normalizedLang !== 'text' ? normalizedLang : 'text');
            
            // ì½”ë“œ ë¸”ë¡ êµì²´
            return templateContent.replace(
                /(##\s*ì œì¶œí•œ\s*ì½”ë“œ[\s\S]*?)```(\w+)?\n([\s\S]*?)```/i,
                `$1\`\`\`${codeLanguage}\n${code.trim()}\n\`\`\``
            );
        }
    }
    
    // "ì œì¶œí•œ ì½”ë“œ" ì„¹ì…˜ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°, ì²« ë²ˆì§¸ ë¹ˆ ì½”ë“œ ë¸”ë¡ì— ì‚½ì…
    const codeBlockPattern = /```(\w+)?\n([\s\S]*?)```/g;
    let isReplaced = false;
    
    const result = templateContent.replace(codeBlockPattern, (match, lang, existingContent) => {
        if (isReplaced) {
            return match; // ì´ë¯¸ êµì²´í–ˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        }
        
        const trimmedContent = existingContent.trim();
        
        // ë¹ˆ ì½”ë“œ ë¸”ë¡ì´ë‚˜ í”Œë ˆì´ìŠ¤í™€ë”ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‚½ì…
        if (!trimmedContent || 
            trimmedContent.includes('ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”') || 
            trimmedContent.includes('Write your code here')) {
            
            isReplaced = true;
            const codeLanguage = (lang && lang !== 'text') ? lang : (normalizedLang !== 'text' ? normalizedLang : 'text');
            return `\`\`\`${codeLanguage}\n${code.trim()}\n\`\`\``;
        }
        
        return match;
    });
    
    return result;
};

export const RetrospectiveWritePage: FC = () => {
    const location = useLocation();
    const navigate = useNavigate();
    const [searchParams] = useSearchParams();
    const createMutation = useCreateRetrospective();
    const updateMutation = useUpdateRetrospective();
    const { completePhase } = useOnboardingStore();
    const {
        data: templateSummaries,
        isLoading: isTemplateSummariesLoading,
        error: templateSummariesError,
    } = useTemplateSummaries();
    const { data: templatesRaw, isLoading: isTemplatesLoading } = useTemplates();
    const renderTemplateMutation = useRenderTemplate();
    const templates = useMemo<TemplateSummary[]>(() => {
        if (templateSummaries && templateSummaries.length > 0) {
            return templateSummaries;
        }
        if (templatesRaw && templatesRaw.length > 0) {
            return templatesRaw.map((template) => ({
                id: template.id,
                studentId: template.studentId,
                title: template.title,
                type: template.type,
                isDefaultSuccess: template.isDefaultSuccess,
                isDefaultFail: template.isDefaultFail,
                createdAt: template.createdAt,
                updatedAt: template.updatedAt,
            }));
        }
        return [];
    }, [templateSummaries, templatesRaw]);

    const isOnboarding = searchParams.get('onboarding') === 'true';
    const queryRetrospectiveId = searchParams.get('retrospectiveId') || '';

    const [retrospectiveId, setRetrospectiveId] = useState<string | null>(null);
    const [problemId, setProblemId] = useState<string>('');
    const [isSuccess, setIsSuccess] = useState<boolean>(false);
    const [resultType, setResultType] = useState<ProblemResult>('FAIL');
    const [content, setContent] = useState<string>('');
    const [summary, setSummary] = useState<string>('');
    const [code, setCode] = useState<string>('');
    const [logId, setLogId] = useState<string | null>(null);
    const [solveTime, setSolveTime] = useState<string | null>(null);
    const [language, setLanguage] = useState<string>('text');
    const [isLoadingTemplate, setIsLoadingTemplate] = useState(false);
    const [hasLoadedTemplate, setHasLoadedTemplate] = useState(false);
    const [selectedTemplateId, setSelectedTemplateId] = useState<string | null>(null);
    const [templateFallbackInfo, setTemplateFallbackInfo] = useState<TemplateFallbackInfo | null>(null);
    const [isPageStateReady, setIsPageStateReady] = useState(false);
    const [editorKey, setEditorKey] = useState<number>(Date.now());
    const templateLoadRequestIdRef = useRef(0);
    const templateContextKeyRef = useRef<string | null>(null);
    const templateAbortControllerRef = useRef<AbortController | null>(null);
    const editHydratedRef = useRef<string | null>(null);

    // ë¬¸ì œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
    const effectiveRetrospectiveId = retrospectiveId || queryRetrospectiveId;
    const { data: retrospectiveForEdit, isLoading: isLoadingRetrospectiveForEdit } = useRetrospective(
        effectiveRetrospectiveId || ''
    );
    const { data: problem, isLoading: isProblemLoading } = useProblemDetail(problemId);

    const category: 'SUCCESS' | 'FAIL' = isSuccess ? 'SUCCESS' : 'FAIL';
    const representativeCategories = useMemo(
        () => buildRepresentativeCategoriesFromSource(problem ?? {}, 8),
        [problem]
    );
    const isMissingProblemContext = isPageStateReady && !problemId && !effectiveRetrospectiveId;
    const isLoadingEditRetrospective =
        Boolean(effectiveRetrospectiveId) &&
        isLoadingRetrospectiveForEdit &&
        !hasLoadedTemplate &&
        !content.trim();

    /**
     * í…œí”Œë¦¿ ë Œë”ë§ ë° ì—ë””í„°ì— ì ìš©
     */
    const loadTemplate = useCallback(
        async (templateId: string, pid: string) => {
            if (!pid || !templateId) {
                return;
            }

            const requestId = ++templateLoadRequestIdRef.current;
            templateAbortControllerRef.current?.abort();
            const abortController = new AbortController();
            templateAbortControllerRef.current = abortController;
            setIsLoadingTemplate(true);
            setTemplateFallbackInfo(null);
            try {
                const problemIdNum = parseInt(pid, 10);
                if (isNaN(problemIdNum)) {
                    throw new Error('Invalid problem ID');
                }

                // í”„ë¡œê·¸ë˜ë° ì–¸ì–´ ì½”ë“œ ë³€í™˜ (ì†Œë¬¸ì -> ëŒ€ë¬¸ì)
                // ì˜ˆ: "kotlin" -> "KOTLIN", "java" -> "JAVA"
                const programmingLanguageValue = language && language !== 'text' ? language.toUpperCase() : null;
                
                // ì½”ë“œì™€ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¥¼ ë°±ì—”ë“œì— ì „ë‹¬í•˜ì—¬ ì½”ë“œ ë¸”ë¡ ì–¸ì–´ íƒœê·¸ ìë™ ì²˜ë¦¬
                const result = await renderTemplateMutation.mutateAsync({
                    templateId,
                    problemId: problemIdNum,
                    code: code || null, // ì œì¶œí•œ ì½”ë“œê°€ ìˆìœ¼ë©´ ì „ë‹¬ (ë°±ì—”ë“œì—ì„œ ì–¸ì–´ ìë™ ê°ì§€ì— ì‚¬ìš©)
                    programmingLanguage: programmingLanguageValue, // ì„ íƒëœ ì–¸ì–´ê°€ ìˆìœ¼ë©´ ì „ë‹¬ (ì½”ë“œ ë¸”ë¡ ì–¸ì–´ íƒœê·¸ë¡œ ì‚¬ìš©)
                    signal: abortController.signal,
                });

                // í…œí”Œë¦¿ ë‚´ìš© ì²˜ë¦¬
                let templateContent = result.renderedContent;
                
                // ì œëª© ìƒì„±ì— í•„ìš”í•œ ì •ë³´ ì¤€ë¹„
                const problemTitle = problem?.title || 'ë¬¸ì œ';
                // ì„±ê³µ: í•´ê²° íšŒê³ , ì‹¤íŒ¨: ë¯¸í•´ê²° íšŒê³ 
                const resultText = isSuccess ? 'í•´ê²°' : 'ë¯¸í•´ê²°';
                const formattedTitle = formatTitle(DEFAULT_TITLE_FORMAT, {
                    problemId: pid,
                    problemTitle,
                    language,
                    result: resultText,
                });
                
                if (!templateContent || templateContent.trim() === '') {
                    // í…œí”Œë¦¿ì´ ë¹„ì–´ìˆì„ ë•Œ ê¸°ë³¸ ì œëª© í˜•ì‹ ì‚¬ìš©
                    templateContent = `${formattedTitle}\n\n`;
                } else {
                    // í…œí”Œë¦¿ ë‚´ìš©ì˜ ì²« ë²ˆì§¸ ì¤„ì´ ì œëª©ì¸ì§€ í™•ì¸
                    const lines = templateContent.split('\n');
                    const firstLine = lines[0]?.trim() || '';
                    
                    // ì²« ë²ˆì§¸ ì¤„ì´ `#`ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ì œëª©ì´ ìˆëŠ” ê²½ìš°)
                    if (firstLine.startsWith('#')) {
                        // ê¸°ì¡´ ì œëª©ì„ ìƒˆë¡œìš´ í˜•ì‹ìœ¼ë¡œ êµì²´
                        // `#`, `##`, `# #`, `## #` ë“± ëª¨ë“  ê²½ìš° ì²˜ë¦¬
                        lines[0] = formattedTitle;
                        templateContent = lines.join('\n');
                    }
                    // ì²« ë²ˆì§¸ ì¤„ì´ `#`ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ì œëª© ì¶”ê°€
                    else {
                        templateContent = `${formattedTitle}\n\n${templateContent}`;
                    }
                }

                // ë°±ì—”ë“œì—ì„œ ì½”ë“œ ë¸”ë¡ì˜ ì–¸ì–´ íƒœê·¸ë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤
                // (programmingLanguage ë˜ëŠ” codeë¥¼ í†µí•´)
                // ë˜í•œ ë°±ì—”ë“œì—ì„œ ì½”ë“œ ë¸”ë¡ì— ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œì¤„ ìˆ˜ ìˆì§€ë§Œ,
                // í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ì¶”ê°€ë¡œ í™•ì¸í•˜ì—¬ ë¹ˆ ì½”ë“œ ë¸”ë¡ì— ì½”ë“œ ì‚½ì…

                // í‹°ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const tierText = problem?.difficulty && problem?.difficultyLevel
                    ? formatTierFromDifficulty(problem.difficulty, problem.difficultyLevel)
                    : null;
                
                // ëª¨ë“  í…œí”Œë¦¿ì— ê¸°ë³¸ ì„¹ì…˜ ë³´ì¥ (ì œì¶œí•œ ì½”ë“œ, ë¬¸ì œ ë§í¬, Generated by DidimLog)
                // í”Œë ˆì´ìŠ¤í™€ë”ë„ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
                templateContent = ensureDefaultSections(templateContent, pid, tierText);
                
                // ì œì¶œí•œ ì½”ë“œê°€ ìˆìœ¼ë©´ ì½”ë“œ ë¸”ë¡ì— ìë™ìœ¼ë¡œ ì±„ìš°ê¸°
                if (code && code.trim()) {
                    templateContent = insertCodeIntoTemplate(templateContent, code, language);
                }

                if (requestId !== templateLoadRequestIdRef.current) {
                    return;
                }
                setContent(templateContent);
                setSelectedTemplateId(templateId);
                if (result.fallbackUsed) {
                    const fallbackReason = result.fallbackReason ?? null;
                    setTemplateFallbackInfo({ reason: fallbackReason });
                    toast.warning(getTemplateFallbackMessage(fallbackReason));
                } else {
                    setTemplateFallbackInfo(null);
                }
                setHasLoadedTemplate(true);
            } catch (error: unknown) {
                if (requestId !== templateLoadRequestIdRef.current) {
                    return;
                }
                if (isApiError(error) && error.code === 'ERR_CANCELED') {
                    return;
                }
                if (isApiError(error) && error.response?.status === 404) {
                    toast.error('ì„ íƒí•œ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
                } else if (
                    isApiError(error) &&
                    (
                        error.response?.status === 504 ||
                        error.response?.data?.code === 'TEMPLATE_RENDER_TIMEOUT' ||
                        error.code === 'ECONNABORTED'
                    )
                ) {
                    toast.error(getTemplateFallbackMessage('TEMPLATE_RENDER_TIMEOUT'));
                } else if (isApiError(error) && error.response?.data?.retryable) {
                    toast.error('í…œí”Œë¦¿ì„ ì¼ì‹œì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
                } else {
                    toast.error('í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                // Fallback: ìµœì†Œí•œì˜ ê¸°ë³¸ í…œí”Œë¦¿ ì œê³µ (ë¬¸ì œ ì œëª© í¬í•¨)
                const problemTitle = problem?.title || 'ë¬¸ì œ';
                const resultText = isSuccess ? 'í•´ê²°' : 'ë¯¸í•´ê²°';
                const formattedTitle = formatTitle(DEFAULT_TITLE_FORMAT, {
                    problemId: pid,
                    problemTitle,
                    language,
                    result: resultText,
                });
                const tierText = problem?.difficulty && problem?.difficultyLevel
                    ? formatTierFromDifficulty(problem.difficulty, problem.difficultyLevel)
                    : null;
                const fallbackTemplate = ensureDefaultSections(
                    `${formattedTitle}\n\n## ì ‘ê·¼ ë°©ë²•\n\n## ë³µì¡ë„ ë¶„ì„\n\n`,
                    pid,
                    tierText
                );
                setSelectedTemplateId(templateId);
                setContent(fallbackTemplate);
                setTemplateFallbackInfo({
                    reason: isApiError(error) ? (error.response?.data?.code ?? null) : null,
                });
                setHasLoadedTemplate(true);
            } finally {
                if (templateAbortControllerRef.current === abortController) {
                    templateAbortControllerRef.current = null;
                }
                if (requestId === templateLoadRequestIdRef.current) {
                    setIsLoadingTemplate(false);
                }
            }
        },
        [renderTemplateMutation, problem, language, isSuccess, code]
    );

    const loadDefaultTemplate = useCallback(
        async (pid: string, forceReload: boolean = false) => {
            if (isLoadingTemplate) {
                return;
            }
            if (templateAbortControllerRef.current) {
                return;
            }

            if (hasLoadedTemplate && !forceReload) {
                return;
            }

            if (!templates || templates.length === 0) {
                return;
            }

            const detailFallback = templates.find((t) =>
                t.title.toLowerCase().includes('detail') || t.title.includes('ìƒì„¸')
            );
            const simpleFallback = templates.find((t) =>
                t.title.toLowerCase().includes('simple') || t.title.includes('ìš”ì•½')
            );

            // ì¹´í…Œê³ ë¦¬ë³„ ê¸°ë³¸ í…œí”Œë¦¿ ì°¾ê¸°
            const categoryTemplate = templates.find((t) => 
                category === 'SUCCESS' ? t.isDefaultSuccess : t.isDefaultFail
            );

            const fallbackTemplate = category === 'SUCCESS' ? simpleFallback : detailFallback;
            const selectedTemplate = categoryTemplate || fallbackTemplate || templates[0];
            if (selectedTemplate) {
                setSelectedTemplateId(selectedTemplate.id);
                await loadTemplate(selectedTemplate.id, pid);
            }
        },
        [templates, hasLoadedTemplate, category, loadTemplate, isLoadingTemplate]
    );

    // ì˜¨ë³´ë”© ëª¨ë“œ: ìë™ìœ¼ë¡œ í¼ ì—´ê¸° (AI ë²„íŠ¼ì´ ë³´ì´ë„ë¡)
    useEffect(() => {
        if (isOnboarding && !isSuccess && problemId) {
            // ì˜¨ë³´ë”© ëª¨ë“œì´ê³  ë¬¸ì œ IDê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ SUCCESS ìƒíƒœë¡œ ì„¤ì •
            setIsSuccess(true);
        }
    }, [isOnboarding, isSuccess, problemId]);

    useEffect(() => {
        if (resultType === 'TIME_OVER') {
            return;
        }
        setResultType(isSuccess ? 'SUCCESS' : 'FAIL');
    }, [isSuccess, resultType]);


    useEffect(() => {
        // location.stateì—ì„œ ì „ë‹¬ëœ ë°ì´í„° í™•ì¸ (ì´ˆê¸° ìƒíƒœë§Œ ë°˜ì˜)
        const state = location.state as {
            retrospectiveId?: string;
            problemId?: string;
            template?: string;
            isSuccess?: boolean;
            code?: string;
            logId?: string | null;
            solveTime?: string | null;
            language?: string;
            initialSummary?: string; // í•œ ì¤„ ìš”ì•½ ì¶”ê°€
            initialSolvedCategory?: string; // í’€ì´ ì „ëµ íƒœê·¸ ì¶”ê°€
            status?: string; // ì¶”ê°€: ëª…ì‹œì  status ì „ë‹¬ (SOLVED/FAIL)
        } | null;

        const queryProblemId = searchParams.get('problemId') || '';
        const queryStatus = searchParams.get('status') || '';
        const queryRetroId = searchParams.get('retrospectiveId') || '';

        if (state) {
            const { retrospectiveId: retroId, problemId: pid, template: temp, isSuccess: success, code: codeValue, logId: createdLogId, solveTime: stateSolveTime, language: stateLanguage, initialSummary: stateSummary, status: stateStatus } = state;
            const effectiveStateRetroId = retroId || queryRetroId;
            
            // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° retrospectiveId ì„¤ì •
            if (effectiveStateRetroId) {
                setRetrospectiveId(effectiveStateRetroId);
            }
            
            // problemId ì„¤ì • (ìµœìš°ì„ )
            if (pid) {
                setProblemId(pid);
            }
            
            // isSuccess ì„¤ì •: status ìš°ì„ , ì—†ìœ¼ë©´ isSuccess ì‚¬ìš©, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ false
            const finalIsSuccess = stateStatus === 'SOLVED' || stateStatus === 'SUCCESS' 
                ? true 
                : (success !== undefined ? success : false);
            setIsSuccess(finalIsSuccess);
            const finalResultType: ProblemResult = stateStatus === 'TIME_OVER'
                ? 'TIME_OVER'
                : finalIsSuccess
                    ? 'SUCCESS'
                    : 'FAIL';
            setResultType(finalResultType);
            setLogId(createdLogId ?? null);
            setCode(codeValue ?? '');
            setSolveTime(stateSolveTime ?? null);
            setLanguage(stateLanguage ?? 'text');
            setSummary(stateSummary ?? ''); // í•œ ì¤„ ìš”ì•½ ì„¤ì •
            
            // í…œí”Œë¦¿ ë¡œë“œ ìš°ì„ ìˆœìœ„:
            // 1. ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ íšŒê³  ë‚´ìš©ì„ ìš°ì„  ì‚¬ìš©
            if (temp && effectiveStateRetroId) {
                setContent(temp);
                setHasLoadedTemplate(true);
                editHydratedRef.current = effectiveStateRetroId;
                setEditorKey(Date.now());
            }
        }
        if (!state?.retrospectiveId && queryRetroId) {
            setRetrospectiveId(queryRetroId);
        }
        if (!state?.problemId && queryProblemId) {
            setProblemId(queryProblemId);
        }
        if (!state?.status && queryStatus) {
            const normalizedQueryStatus = queryStatus.toUpperCase();
            if (normalizedQueryStatus === 'TIME_OVER') {
                setIsSuccess(false);
                setResultType('TIME_OVER');
            } else if (normalizedQueryStatus === 'SUCCESS' || normalizedQueryStatus === 'SOLVED') {
                setIsSuccess(true);
                setResultType('SUCCESS');
            } else if (normalizedQueryStatus === 'FAIL') {
                setIsSuccess(false);
                setResultType('FAIL');
            }
        }
        setIsPageStateReady(true);
    }, [location.state, searchParams]);

    useEffect(() => {
        if (!effectiveRetrospectiveId || !retrospectiveForEdit) {
            return;
        }
        if (editHydratedRef.current === effectiveRetrospectiveId) {
            return;
        }

        const normalizedResult = (retrospectiveForEdit.solutionResult || '').toUpperCase();
        const hydratedIsSuccess = normalizedResult === 'SUCCESS' || normalizedResult === 'SOLVED';
        const hydratedResultType: ProblemResult =
            normalizedResult === 'TIME_OVER' ? 'TIME_OVER' : hydratedIsSuccess ? 'SUCCESS' : 'FAIL';

        setRetrospectiveId(retrospectiveForEdit.id);
        setProblemId(retrospectiveForEdit.problemId);
        setIsSuccess(hydratedIsSuccess);
        setResultType(hydratedResultType);
        setSummary(retrospectiveForEdit.summary || '');
        setSolveTime(retrospectiveForEdit.solveTime || null);
        setContent(retrospectiveForEdit.content || '');
        setHasLoadedTemplate(true);
        setTemplateFallbackInfo(null);
        setEditorKey(Date.now());
        editHydratedRef.current = effectiveRetrospectiveId;
    }, [effectiveRetrospectiveId, retrospectiveForEdit]);

    // ë¬¸ì œ/ê²°ê³¼ ì»¨í…ìŠ¤íŠ¸ê°€ ë°”ë€Œë©´ ì´ì „ í…œí”Œë¦¿ ìƒíƒœë¥¼ ë¬´íš¨í™”í•˜ì—¬ ì˜ëª»ëœ í…œí”Œë¦¿ ì”ì¡´ì„ ë°©ì§€
    useEffect(() => {
        if (!problemId || retrospectiveId) {
            return;
        }
        const contextKey = `${problemId}:${category}`;
        if (templateContextKeyRef.current === contextKey) {
            return;
        }
        templateContextKeyRef.current = contextKey;
        templateLoadRequestIdRef.current += 1;
        templateAbortControllerRef.current?.abort();
        templateAbortControllerRef.current = null;
        setIsLoadingTemplate(false);
        setHasLoadedTemplate(false);
        setSelectedTemplateId(null);
        setTemplateFallbackInfo(null);
        setContent('');
    }, [problemId, category, retrospectiveId]);

    useEffect(() => {
        return () => {
            templateAbortControllerRef.current?.abort();
        };
    }, []);

    // templatesê°€ ë¡œë“œëœ í›„ ë˜ëŠ” isSuccess ë³€ê²½ ì‹œ ê¸°ë³¸ í…œí”Œë¦¿ ìë™ ë¡œë“œ
    useEffect(() => {
        if (!isPageStateReady) {
            return;
        }
        if (isLoadingTemplate) {
            return;
        }
        if (problemId && !hasLoadedTemplate && !retrospectiveId) {
            // ì¹´í…Œê³ ë¦¬ë³„ ê¸°ë³¸ í…œí”Œë¦¿ì´ ë¡œë“œë˜ë©´ ìë™ìœ¼ë¡œ ì ìš©
            if (templates.length > 0) {
                // í…œí”Œë¦¿ ëª©ë¡ì´ ìˆìœ¼ë©´ ë¡œë“œ ì‹œë„
                loadDefaultTemplate(problemId).catch(() => {
                    // Template load failed
                });
            } else if (!isTemplateSummariesLoading && !isTemplatesLoading) {
                // í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨/ë¹ˆ ê²°ê³¼ ì‹œ ìµœì†Œ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ ì¦‰ì‹œ ì§„í–‰ (ë¹ˆ ì—ë””í„° ë°©ì§€)
                const problemTitle = problem?.title || 'ë¬¸ì œ';
                const resultText = isSuccess ? 'í•´ê²°' : 'ë¯¸í•´ê²°';
                const formattedTitle = formatTitle(DEFAULT_TITLE_FORMAT, {
                    problemId,
                    problemTitle,
                    language,
                    result: resultText,
                });
                const tierText = problem?.difficulty && problem?.difficultyLevel
                    ? formatTierFromDifficulty(problem.difficulty, problem.difficultyLevel)
                    : null;
                const emergencyTemplate = ensureDefaultSections(
                    `${formattedTitle}\n\n## ì ‘ê·¼ ë°©ë²•\n\n## ë³µì¡ë„ ë¶„ì„\n\n`,
                    problemId,
                    tierText
                );
                setContent(emergencyTemplate);
                setTemplateFallbackInfo({
                    reason: templateSummariesError ? 'TEMPLATE_LIST_UNAVAILABLE' : 'TEMPLATE_NOT_CONFIGURED',
                });
                setHasLoadedTemplate(true);
                if (templateSummariesError) {
                    toast.error('í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í•˜ì—¬ ê¸°ë³¸ í…œí”Œë¦¿ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
    }, [
        problemId,
        hasLoadedTemplate,
        retrospectiveId,
        templates,
        loadDefaultTemplate,
        isPageStateReady,
        isTemplateSummariesLoading,
        isTemplatesLoading,
        templateSummariesError,
        isLoadingTemplate,
        problem,
        isSuccess,
        language,
    ]);

    // codeê°€ ì„¤ì •ëœ í›„ ì´ë¯¸ í…œí”Œë¦¿ì´ ë¡œë“œë˜ì—ˆê³  ì½”ë“œ ë¸”ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ì½”ë“œ ì‚½ì…
    useEffect(() => {
        if (code && code.trim() && selectedTemplateId && problemId && hasLoadedTemplate && !retrospectiveId && content) {
            // í˜„ì¬ contentì— ë¹ˆ ì½”ë“œ ë¸”ë¡ì´ ìˆëŠ”ì§€ í™•ì¸
            // íŒ¨í„´: ```language\nì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”\n``` ë˜ëŠ” ```language\n\n``` ë˜ëŠ” ```language\n```
            const hasEmptyCodeBlock = /```\w*\n\s*(ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”|Write your code here|)\s*```/i.test(content) ||
                /```\w*\n\s*```/.test(content) ||
                /##\s*ì œì¶œí•œ\s*ì½”ë“œ[\s\S]*?```\w*\n\s*```/i.test(content);
            
            if (hasEmptyCodeBlock) {
                // ì½”ë“œ ë¸”ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ content ì—…ë°ì´íŠ¸
                const updatedContent = insertCodeIntoTemplate(content, code, language);
                if (updatedContent !== content) {
                    setContent(updatedContent);
                }
            }
        }
    }, [code, selectedTemplateId, problemId, hasLoadedTemplate, retrospectiveId, content, language]);

    const handleCopyMarkdown = async () => {
        if (!content.trim() || !problemId) {
            toast.error('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // AI Generated ë¬¸êµ¬ ì œê±° (í‘¸í„°ëŠ” ë°±ì—”ë“œ/AIì—ì„œ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
        let markdownContent = content.trim();
        
        // AI Generated ê´€ë ¨ ë¬¸êµ¬ ì œê±° (ëŒ€ì†Œë¬¸ì ë¬´ê´€)
        markdownContent = markdownContent
            .replace(/AI Generated/gi, '')
            .replace(/AI generated/gi, '')
            .replace(/Generated by AI/gi, '')
            .replace(/generated by ai/gi, '')
            .replace(/AIê°€ ìƒì„±/gi, '')
            .replace(/ìë™ ìƒì„±/gi, '')
            .trim();

        try {
            await navigator.clipboard.writeText(markdownContent);
            toast.success('ë§ˆí¬ë‹¤ìš´ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch {
            toast.error('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
    };

    const handleSubmit = async (data: RetrospectiveRequest) => {
        if (!problemId) {
            toast.error('ë¬¸ì œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            // resultTypeì€ í™”ë©´ ì»¨í…ìŠ¤íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì„¤ì • (SUCCESS/FAIL/TIME_OVER)
            const finalData: RetrospectiveRequest = {
                ...data,
                resultType,
            };

            // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš°
            if (retrospectiveId) {
                await updateMutation.mutateAsync({ retrospectiveId, data: finalData });
                toast.success('íšŒê³ ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                navigate(`/retrospectives/${retrospectiveId}`);
            } else {
                // ìƒˆë¡œ ì‘ì„±í•˜ëŠ” ê²½ìš°
                await createMutation.mutateAsync({ problemId, data: finalData });
                toast.success('íšŒê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ì˜¨ë³´ë”© Phase ì™„ë£Œ ì²˜ë¦¬
                completePhase('retrospective');
                
                navigate('/retrospectives');
            }
        } catch (error: unknown) {
            const errorMessage = getErrorMessage(error);
            
            // ë°±ì—”ë“œì—ì„œ ì†Œìœ ì ê²€ì¦ ì‹¤íŒ¨ ì‹œ
            if (isApiError(error) && (error.response?.status === 403 || error.response?.status === 400)) {
                toast.error('ë³¸ì¸ì´ ì‘ì„±í•œ íšŒê³ ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                toast.error(errorMessage);
            }
        }
    };

    const handleContentChange = (newContent: string) => {
        setContent(newContent);
    };

    /**
     * í…œí”Œë¦¿ ë³€ê²½ í•¸ë“¤ëŸ¬
     */
    const handleTemplateChange = async (templateId: string) => {
        if (templateId === selectedTemplateId) {
            return;
        }

        // ì‚¬ìš©ìê°€ ì´ë¯¸ ë‚´ìš©ì„ ì‘ì„± ì¤‘ì´ë©´ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        const hasUserContent = content.trim() !== '';

        if (hasUserContent) {
            const confirmed = window.confirm('í…œí”Œë¦¿ì„ ë³€ê²½í•˜ë©´ í˜„ì¬ ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmed) {
                return;
            }
        }

        if (problemId) {
            await loadTemplate(templateId, problemId);
            setEditorKey(Date.now());
        }
    };

    return (
        <Layout>
            <div className="min-h-screen bg-gray-50 dark:bg-gray-900 py-8 px-4">
                <div className="max-w-4xl mx-auto space-y-8">
                    {/* ğŸ¨ Global Header - í‘œì¤€í™”ëœ ë„¤ë¹„ê²Œì´ì…˜ */}
                    {problemId && (
                        <div className="flex items-center justify-between mb-6">
                            {/* ì™¼ìª½: ë„¤ë¹„ê²Œì´ì…˜ & ì œëª© */}
                            <div className="flex-1 min-w-0">
                                {isProblemLoading ? (
                                    <div className="flex items-center gap-3">
                                        <Spinner />
                                        <span className="text-gray-600 dark:text-gray-400">ë¬¸ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                                    </div>
                                ) : problem ? (
                                    <div className="flex items-center gap-3">
                                        {/* ì´ì „ ë²„íŠ¼ (ì•„ì´ì½˜ë§Œ) */}
                                        <button
                                            onClick={() => navigate(-1)}
                                            className="flex-shrink-0 p-1.5 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                            title="ì´ì „ í˜ì´ì§€ë¡œ"
                                        >
                                            <ChevronLeft className="w-5 h-5" />
                                        </button>
                                        {/* ë¬¸ì œ ë²ˆí˜¸ & íƒœê·¸ */}
                                        <div className="flex items-center gap-3 flex-wrap">
                                                {/* íƒœê·¸ */}
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <span className="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-sm font-medium">
                                                        {representativeCategories[0]
                                                            ? getCategoryLabel(representativeCategories[0])
                                                            : problem.category}
                                                    </span>
                                                <span className={`px-2 py-1 rounded text-sm font-medium whitespace-nowrap ${getTierColor(problem.difficulty)}`}>
                                                    {formatTierFromDifficulty(problem.difficulty, problem.difficultyLevel)}
                                                </span>
                                                {/* ì–¸ì–´ ë°°ì§€ */}
                                                <LanguageBadge language={language} />
                                                {/* ì•Œê³ ë¦¬ì¦˜ íƒœê·¸ */}
                                                {representativeCategories.length > 1 ? (
                                                    <>
                                                        {representativeCategories.slice(1, 6).map((tag, index) => (
                                                            <span
                                                                key={index}
                                                                className="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs"
                                                            >
                                                                {getCategoryLabel(tag)}
                                                            </span>
                                                        ))}
                                                    </>
                                                ) : problem.tags && problem.tags.length > 0 ? (
                                                    <>
                                                        {problem.tags.map((tag, index) => (
                                                            <span
                                                                key={index}
                                                                className="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs"
                                                            >
                                                                {tag}
                                                            </span>
                                                        ))}
                                                    </>
                                                ) : null}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-3">
                                        <button
                                            onClick={() => navigate(-1)}
                                            className="flex-shrink-0 p-1.5 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                            title="ì´ì „ í˜ì´ì§€ë¡œ"
                                        >
                                            <ChevronLeft className="w-5 h-5" />
                                        </button>
                                        <p className="text-gray-600 dark:text-gray-400">ë¬¸ì œ #{problemId} ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* í—¤ë” (ì•¡ì…˜ ë²„íŠ¼) */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between">
                            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
                                {retrospectiveId ? 'íšŒê³  ìˆ˜ì •' : 'íšŒê³  ì‘ì„±'}
                            </h2>
                            <div className="flex items-center gap-3">
                                <Button 
                                    onClick={handleCopyMarkdown} 
                                    variant="outline" 
                                    className="flex items-center gap-2"
                                >
                                    <Copy className="w-4 h-4" />
                                    Markdown ë³µì‚¬
                                </Button>
                            </div>
                        </div>
                    </div>

                    {/* AI í•œ ì¤„ ì¸ì‚¬ì´íŠ¸ (íšŒê³  ì‘ì„± í—¤ë” ì•„ë˜, í•œ ì¤„ ìš”ì•½ ìœ„) */}
                    <div className="mb-6 tour-ai-section">
                        <AiReviewCard 
                            logId={logId} 
                            code={code}
                            isSuccess={isSuccess}
                            problemId={problemId}
                            problemTitle={problem?.title}
                        />
                    </div>

                    {isMissingProblemContext && (
                        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4">
                            <p className="text-sm text-yellow-800 dark:text-yellow-200">
                                ë¬¸ì œ ì •ë³´ê°€ ì—†ì–´ ê¸°ë³¸ í…œí”Œë¦¿ì„ ì ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì œ/ìŠ¤í„°ë”” í™”ë©´ì—ì„œ ë‹¤ì‹œ íšŒê³  ì‘ì„±ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.
                            </p>
                        </div>
                    )}

                    {isLoadingTemplate && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 border border-gray-200 dark:border-gray-700">
                            <div className="flex items-center justify-center py-12">
                                <Spinner />
                                <span className="ml-3 text-gray-600 dark:text-gray-400">í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                            </div>
                        </div>
                    )}

                    {/* í…œí”Œë¦¿ ì„ íƒ ë“œë¡­ë‹¤ìš´ */}
                    {isLoadingEditRetrospective && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 border border-gray-200 dark:border-gray-700">
                            <div className="flex items-center justify-center py-8">
                                <Spinner />
                                <span className="ml-3 text-gray-600 dark:text-gray-400">ê¸°ì¡´ íšŒê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                            </div>
                        </div>
                    )}

                    {!isLoadingTemplate && !retrospectiveId && problemId && templates && templates.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border border-gray-200 dark:border-gray-700">
                            <div className="flex items-center gap-3">
                                <label htmlFor="template-select" className="text-sm font-medium text-gray-700 dark:text-gray-300">
                                    í…œí”Œë¦¿ ì„ íƒ:
                                </label>
                                <select
                                    id="template-select"
                                    value={selectedTemplateId || ''}
                                    onChange={(e) => {
                                        if (e.target.value) {
                                            handleTemplateChange(e.target.value);
                                        }
                                    }}
                                    className="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {templates.map((template) => (
                                        <option key={template.id} value={template.id}>
                                            {template.isDefaultSuccess ? 'âœ… ' : ''}
                                            {template.isDefaultFail ? 'âŒ ' : ''}
                                            {template.type === 'SYSTEM' ? 'ğŸ”§ ' : ''}
                                            {template.title}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    )}

                    {!isLoadingTemplate && retrospectiveId && (
                        <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl px-4 py-3">
                            <p className="text-sm text-blue-800 dark:text-blue-200">
                                ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ì €ì¥ëœ íšŒê³  ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ í¸ì§‘í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    )}

                    {!isLoadingTemplate && templateFallbackInfo && (
                        <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl px-4 py-3">
                            <div className="flex items-center gap-2">
                                <span className="inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900/40 px-2 py-1 text-xs font-semibold text-amber-800 dark:text-amber-200">
                                    í…œí”Œë¦¿ fallback ì ìš©
                                </span>
                                <p className="text-sm text-amber-800 dark:text-amber-200">
                                    {getTemplateFallbackMessage(templateFallbackInfo.reason)}
                                </p>
                            </div>
                        </div>
                    )}

                    {/* íšŒê³  ì—ë””í„° */}
                    {!isLoadingTemplate && !isLoadingEditRetrospective && !isMissingProblemContext && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-8 border border-gray-200 dark:border-gray-700">
                            <RetrospectiveEditor
                                key={editorKey}
                                initialContent={content}
                                initialSummary={summary}
                                initialSolvedCategory={location.state?.initialSolvedCategory}
                                onSubmit={(data) => {
                                    handleSubmit({
                                        ...data,
                                        solveTime: solveTime || data.solveTime,
                                    });
                                }}
                                isLoading={createMutation.isPending || updateMutation.isPending}
                                onContentChange={handleContentChange}
                                recommendedTags={representativeCategories}
                            />
                        </div>
                    )}
                </div>
            </div>
        </Layout>
    );
};
