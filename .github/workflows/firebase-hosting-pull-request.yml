# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      # ÎπåÎìú Ï†Ñ Ï∫êÏãú Î∞è Ïù¥Ï†Ñ ÎπåÎìú ÏÇ∞Ï∂úÎ¨º Ï†ïÎ¶¨
      - name: Clean build artifacts and cache
        run: |
          echo "üßπ Cleaning build artifacts and cache..."
          rm -rf dist
          rm -rf node_modules/.vite
          echo "‚úÖ Cleanup completed"

      # 1. ÎπåÎìú Ïãú ÌôòÍ≤Ω Î≥ÄÏàò Ï£ºÏûÖ (Ï§ëÏöî!)
      # - Ïã§Ï†ú API Ï£ºÏÜåÎäî Î†àÌè¨Ïóê ÌïòÎìúÏΩîÎî©ÌïòÏßÄ ÏïäÍ≥† GitHub SecretsÎ°úÎßå Í¥ÄÎ¶¨Ìï©ÎãàÎã§.
      - run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      # 2. [Í≤ÄÏ¶ù Îã®Í≥Ñ] ÎπåÎìú ÏÇ∞Ï∂úÎ¨ºÏóê localhostÍ∞Ä ÏÑûÏù¥ÏßÄ ÏïäÏïòÎäîÏßÄ ÌôïÏù∏
      - name: Verify no localhost in build artifacts
        run: |
          echo "üîé Checking build artifacts..."

          if [ -z "${{ secrets.VITE_API_URL }}" ]; then
            echo "‚ùå Error: VITE_API_URL secret is not set."
            exit 1
          fi

          if grep -r "localhost:8080" dist/ > /dev/null; then
            echo "‚ùå Error: Build artifacts contain localhost:8080."
            exit 1
          fi

          echo "‚úÖ Success: No localhost:8080 found in build artifacts."

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DIDIM_LOG_FE }}
          projectId: didim-log-fe

